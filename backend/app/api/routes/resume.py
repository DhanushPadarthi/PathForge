from fastapi import APIRouter, UploadFile, File, Depends, HTTPException, status\nfrom datetime import datetime\nimport logging\n\nfrom ...config.mongodb import db\nfrom ...core.dependencies import get_current_active_user\nfrom ...services.resume_parser import resume_parser\nfrom ...services.skill_analyzer import skill_analyzer\n\nlogger = logging.getLogger(__name__)\nrouter = APIRouter()\n\n@router.post(\"/upload\")\nasync def upload_resume(\n    file: UploadFile = File(...),\n    current_user: dict = Depends(get_current_active_user)\n):\n    \"\"\"\n    Upload and parse resume file (PDF/DOCX)\n    Extract skills using AI\n    \"\"\"\n    try:\n        # Validate file type\n        allowed_extensions = [\".pdf\", \".docx\", \".doc\"]\n        file_ext = \".\" + file.filename.split(\".\")[-1].lower()\n        \n        if file_ext not in allowed_extensions:\n            raise HTTPException(\n                status_code=status.HTTP_400_BAD_REQUEST,\n                detail=f\"File type not allowed. Allowed types: {', '.join(allowed_extensions)}\"\n            )\n        \n        # Read file content\n        file_content = await file.read()\n        \n        # Validate file size (10MB max)\n        if len(file_content) > 10 * 1024 * 1024:\n            raise HTTPException(\n                status_code=status.HTTP_400_BAD_REQUEST,\n                detail=\"File size exceeds 10MB limit\"\n            )\n        \n        # Parse resume\n        logger.info(f\"Parsing resume for user {current_user['_id']}\")\n        resume_text = await resume_parser.parse_resume(file_content, file.filename)\n        \n        if not resume_text or len(resume_text) < 50:\n            raise HTTPException(\n                status_code=status.HTTP_400_BAD_REQUEST,\n                detail=\"Could not extract text from resume. Please ensure the file contains readable text.\"\n            )\n        \n        # Extract skills using AI\n        logger.info(\"Extracting skills using AI\")\n        extracted_skills = await skill_analyzer.analyze_resume_skills(resume_text)\n        \n        # Update user document\n        users_collection = db.get_collection(\"users\")\n        await users_collection.update_one(\n            {\"_id\": current_user[\"_id\"]},\n            {\n                \"$set\": {\n                    \"has_resume\": True,\n                    \"extracted_skills\": extracted_skills,\n                    \"resume_text\": resume_text[:5000],  # Store first 5000 chars\n                    \"resume_filename\": file.filename,\n                    \"updated_at\": datetime.utcnow()\n                }\n            }\n        )\n        \n        return {\n            \"message\": \"Resume uploaded and processed successfully\",\n            \"extracted_skills\": extracted_skills,\n            \"skills_count\": len(extracted_skills),\n            \"filename\": file.filename\n        }\n        \n    except HTTPException:\n        raise\n    except Exception as e:\n        logger.error(f\"Error processing resume: {e}\")\n        raise HTTPException(\n            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,\n            detail=f\"Failed to process resume: {str(e)}\"\n        )\n\n@router.get(\"/skills\")\nasync def get_user_skills(current_user: dict = Depends(get_current_active_user)):\n    \"\"\"\n    Get extracted skills for current user\n    \"\"\"\n    return {\n        \"has_resume\": current_user.get(\"has_resume\", False),\n        \"extracted_skills\": current_user.get(\"extracted_skills\", []),\n        \"resume_filename\": current_user.get(\"resume_filename\"),\n        \"skills_count\": len(current_user.get(\"extracted_skills\", []))\n    }\n\n@router.delete(\"/\")\nasync def delete_resume(current_user: dict = Depends(get_current_active_user)):\n    \"\"\"\n    Delete user's resume data\n    \"\"\"\n    users_collection = db.get_collection(\"users\")\n    await users_collection.update_one(\n        {\"_id\": current_user[\"_id\"]},\n        {\n            \"$set\": {\n                \"has_resume\": False,\n                \"extracted_skills\": [],\n                \"resume_text\": None,\n                \"resume_filename\": None,\n                \"updated_at\": datetime.utcnow()\n            }\n        }\n    )\n    \n    return {\"message\": \"Resume deleted successfully\"}
